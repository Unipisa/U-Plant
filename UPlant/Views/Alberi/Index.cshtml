@model List<UPlant.Models.DB.Alberi>
@inject LanguageService language

@{
    ViewBag.Title = language.Getkey("Global_Tree");
    ViewBag.lang = language.GetCurrentCulture();
}

<h4 class="box-title">@language.Getkey("Shared_Comp_Sb_Tree")</h4>

<!-- Bottone toggle Aggiungi/Chiudi -->
<button class="btn btn-primary btn-sm mb-2"
        type="button"
        id="btnToggleAggiungi"
        data-toggle="collapse"
        data-target="#addIndividuoCollapse"
        aria-expanded="false"
        aria-controls="addIndividuoCollapse">
    <i class="fa-solid fa-plus"></i> Aggiungi
</button>

<!-- Card Aggiungi Individuo (inizialmente nascosta) -->
<div class="collapse" id="addIndividuoCollapse">
    <div class="card card-outline card-primary mt-2">
        <div class="card-body">

            <h4 class="box-title">@language.Getkey("Global_Add") @language.Getkey("Global_Individual")</h4>

            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="form-label">@language.Getkey("Global_Scientific_Name")</label>
                    <input id="nomescientifico" name="nomescientifico" class="form-control" type="text"
                           placeholder="@language.Getkey("Global_Scientific_Name")">
                </div>
                <div class="col-md-2">
                    <button type="button" id="cerca" class="btn btn-success">
                        @language.Getkey("Global_Search")
                    </button>
                </div>
            </div>

            <!-- Risultati ricerca (nascosti finché non arrivano) -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="risultato2" class="card card-outline card-info d-none">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Risultati ricerca</h5>
                        </div>
                        <div class="card-body">
                            <div id="risultato2Content"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Elenco principale -->
<div class="card card-outline card-primary mt-3">

    <!-- Header: Visualizza a sinistra / Cerca a destra -->
    <div class="card-header">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <h3 class="card-title mb-0 mr-3">Elenco Individui con Interventi</h3>
                <div id="table1HeaderLeft" class="d-flex align-items-center"></div>
            </div>
            <div id="table1HeaderRight" class="d-flex align-items-center"></div>
        </div>
    </div>

    <div class="card-body">
        <table id="table1" class="table table-bordered table-striped table-sm">
            <thead>
                <tr>
                    <th style="width:60px;"></th>
                    <th>@language.Getkey("Global_Progressive")</th>
                    <th>@language.Getkey("Global_Scientific_Name")</th>
                    <th>@language.Getkey("Global_Sector")</th>
                    <th>@language.Getkey("Global_Collection")</th>
                    <th>@language.Getkey("Global_Tree_Priority")</th>
                    <th>@language.Getkey("Global_Last_Modified_Date")</th>
                    <th>Stato</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td class="text-center">
                            <a asp-action="ElencoInterventi"
                               asp-controller="Alberi"
                               asp-route-id="@item.individuo"
                               class="btn btn-primary btn-sm"
                               title="@($"{language.Getkey("Global_Detail")} {language.Getkey("Global_Individual")}")">
                                <i class="fa-solid fa-search"></i>
                            </a>
                        </td>

                        <td class="text-center">@item.individuoNavigation.progressivo</td>
                        <td class="text-center">@item.individuoNavigation.accessioneNavigation.specieNavigation.nome_scientifico</td>
                        <td class="text-center">@item.individuoNavigation.collezioneNavigation.settoreNavigation.settore</td>
                        <td class="text-center">@item.individuoNavigation.collezioneNavigation.collezione</td>
                        <td class="text-center">@item.prioritaNavigation.descrizione</td>

                        <td class="text-center">@item.dataultimamodifica.ToString("dd/MM/yyyy HH:mm")</td>

                        <td class="text-center">@(item.stato == false ? "Aperto" : "Chiuso")</td>
                    </tr>
                }
            </tbody>
        </table>

        @if (!Model.Any())
        {
            <div class="text-center text-muted mt-2">
                @language.Getkey("Global_NoResults")
            </div>
        }
    </div>
</div>

@section CustomStyles {
    <style>
        /* Autocomplete */
        .ui-autocomplete {
            margin: 0px;
            font-family: Arial, Verdana, Sans-Serif;
            float: left;
            width: 10%;
            list-style-type: none;
            color: #0060B6;
            text-decoration: none;
        }

            .ui-autocomplete .fixed-height {
                float: left;
                max-height: 175px;
                overflow: auto !important;
                list-style-type: none;
            }

                .ui-autocomplete .fixed-height li {
                    font-family: Arial, Verdana, Sans-Serif;
                    float: left;
                    width: 100%;
                    text-align: left;
                    font: bold 26px Poiret One;
                }

            .ui-autocomplete .ui-menu-item .ui-corner-all {
                float: left;
                width: 100%;
                height: 30px;
                padding: 10px 0;
                background: #FFF;
            }

            .ui-autocomplete .ui-menu-item .ui-state-focus {
                background-color: #00F;
                cursor: pointer;
            }

        /* Header controlli DataTables */
        #table1HeaderLeft label,
        #table1HeaderRight label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        #table1HeaderLeft select {
            width: 90px;
            display: inline-block;
            margin: 0 6px;
        }

        #table1HeaderRight input {
            width: 190px;
            display: inline-block;
            margin-left: 6px;
        }

        /* evita che vada a capo */
        #table1HeaderLeft, #table1HeaderRight {
            gap: 10px;
        }
    </style>
}

@section Scripts {
    <script src="~/js/datatables.min.js"></script>
}

@section CustomScripts {
    <script type="text/javascript">
        $(document).ready(function () {

            // Lingua DataTables
            var lingua = "@ViewBag.lang";
            if (lingua === "en-US") {
                $.extend($.fn.dataTable.defaults, {
                    language: { url: "/js/dataTables.english.json" }
                });
            } else {
                $.extend($.fn.dataTable.defaults, {
                    language: { url: "/js/dataTables.default.json" }
                });
            }

            // Autocomplete
            var baseUrlauto = '@Url.Action("AutoComplete", "Alberi")';
            $("#nomescientifico").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: baseUrlauto,
                        dataType: "json",
                        data: { term: request.term, field: "nome_scientifico" },
                        success: function (data) { response(data); }
                    });
                }
            });

            // DataTables (DEFAULT layout, poi spostiamo i controlli)
            var dt = $('#table1').DataTable({
                paging: true,
                lengthChange: true,
                searching: true,
                info: true,
                autoWidth: false,
                ordering: true
            });

            // Sposta "Visualizza" a sinistra e "Cerca" a destra nel header
            var wrapper = $('#table1').closest('.dataTables_wrapper');

            $('#table1HeaderLeft').empty().append(wrapper.find('#table1_length').detach());
            $('#table1HeaderRight').empty().append(wrapper.find('#table1_filter').detach());

            // Ordine iniziale: Data Ultima Modifica DESC (colonna 6)
            dt.order([6, 'desc']).draw();

            // Ricerca individui per aggiunta
            var baseUrlRicerca = '@Url.Action("Ricerca", "Alberi")';

            $("#cerca").click(function () {
                var prog = $('#nomescientifico').val();

                $.ajax({
                    type: "GET",
                    url: baseUrlRicerca,
                    dataType: "json",
                    data: { nome_scientifico: prog },
                    success: function (data) {

                        if (!data || data.length === 0) {
                            $("#risultato2Content").html('<div class="alert alert-warning mb-0">Nessun individuo trovato.</div>');
                            $("#risultato2").removeClass("d-none");
                            return;
                        }

                        var progre = "@language.Getkey("Global_Progressive")";
                        var namesc = "@language.Getkey("Global_Scientific_Name")";
                        var oldprog = "@language.Getkey("Global_Old_Progressive")";
                        var sector = "@language.Getkey("Global_Sector")";
                        var coll = "@language.Getkey("Global_Collection")";
                        var lab = "@language.Getkey("Global_Label")";
                        var imgs = "@language.Getkey("Global_Images")";
                        var add = "@language.Getkey("Global_Add")";
                        var ind = "@language.Getkey("Global_Individual")";

                        var s = '';
                        s += '<table id="tableSearch" class="table table-bordered table-striped table-sm">';
                        s += '<thead><tr>';
                        s += '<th style="width:60px;"></th>';
                        s += '<th>' + progre + '</th>';
                        s += '<th>' + oldprog + '</th>';
                        s += '<th>' + namesc + '</th>';
                        s += '<th>' + sector + '</th>';
                        s += '<th>' + coll + '</th>';
                        s += '<th>' + lab + '</th>';
                        s += '<th>' + imgs + '</th>';
                        s += '</tr></thead><tbody>';

                        for (var i = 0; i < data.length; i++) {
                            var indi = data[i].idindividuo;
                            var action = '@Url.Action("Create", "Alberi")' + '?idindividuo=' + encodeURIComponent(indi);

                            s += '<tr>';
                            s += '<td class="text-center">';
                            s += '<a class="btn btn-success btn-sm" title="' + add + ' ' + ind + '" href="' + action + '">';
                            s += '<i class="fa-solid fa-plus"></i>';
                            s += '</a>';
                            s += '</td>';

                            s += '<td>' + (data[i].progressivo ?? '') + '</td>';
                            s += '<td>' + (data[i].vecchioprogressivo ?? '') + '</td>';
                            s += '<td>' + (data[i].nomescientifico ?? '') + '</td>';
                            s += '<td>' + (data[i].settore ?? '') + '</td>';
                            s += '<td>' + (data[i].collezione ?? '') + '</td>';
                            s += '<td>' + (data[i].cartellino ?? '') + '</td>';
                            s += '<td>' + (data[i].immagini ?? '') + '</td>';
                            s += '</tr>';
                        }

                        s += '</tbody></table>';

                        $("#risultato2Content").html(s);
                        $("#risultato2").removeClass("d-none");

                        if ($.fn.DataTable.isDataTable('#tableSearch')) {
                            $('#tableSearch').DataTable().destroy();
                        }

                        $('#tableSearch').DataTable({
                            paging: true,
                            lengthChange: false,
                            searching: false,
                            info: false,
                            ordering: true,
                            autoWidth: false
                        });
                    },
                    error: function (xhr) {
                        $("#risultato2Content").html(
                            '<div class="alert alert-danger mb-0">Errore durante la ricerca:<br>' + (xhr.responseText ?? '') + '</div>'
                        );
                        $("#risultato2").removeClass("d-none");
                    }
                });
            });

            // Cambio testo bottone Aggiungi/Chiudi
            $('#addIndividuoCollapse')
                .on('shown.bs.collapse', function () {
                    $('#btnToggleAggiungi')
                        .removeClass('btn-primary')
                        .addClass('btn-secondary')
                        .html('<i class="fa-solid fa-xmark"></i> Chiudi');
                })
                .on('hidden.bs.collapse', function () {
                    $('#btnToggleAggiungi')
                        .removeClass('btn-secondary')
                        .addClass('btn-primary')
                        .html('<i class="fa-solid fa-plus"></i> Aggiungi');
                });

        });
    </script>
}
